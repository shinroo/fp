{{define "stylesheets"}}
<style>
    .profile-form {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .range-label {
        width: 300px;
    }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
    integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
    crossorigin="" />
{{end}}

{{define "title"}}Profile{{end}}

{{define "content"}}
<form class="profile-form" id="profile-form">
    <div>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Dog preferences</h5>
                <h6 class="card-subtitle mb-2 text-muted">Please describe your ideal dog</h6>

                <hr>

                <!-- Affectionate with family -->
                <div class="form-group">
                    <label for="affectionateWithFamily" class="form-label">
                        <strong>Affectionate with family</strong>
                    </label>
                    <div class="d-flex align-items-center">
                        <span class="me-2 range-label">Not affectionate</span>
                        <input type="range" class="form-range flex-grow-1 mx-2" min="1" max="5" step="1"
                            id="affectionateWithFamily">
                        <span class="ms-2 range-label">Very affectionate</span>
                    </div>
                </div>

                <br>

                <!-- Good with young children -->
                <div class="form-group">
                    <label for="goodWithYoungChildren" class="form-label">
                        <strong>Good with other children</strong>
                    </label>
                    <div class="d-flex align-items-center">
                        <span class="me-2 range-label">Not good with children</span>
                        <input type="range" class="form-range flex-grow-1 mx-2" min="1" max="5" step="1"
                            id="goodWithYoungChildren">
                        <span class="ms-2 range-label">Great with children</span>
                    </div>
                </div>

                <br>

                <!-- Good with other dogs -->
                <div class="form-group">
                    <label for="goodWithOtherDogs" class="form-label">
                        <strong>Good with other dogs</strong>
                    </label>
                    <div class="d-flex align-items-center">
                        <span class="me-2 range-label">Doesn't like other dogs</span>
                        <input type="range" class="form-range flex-grow-1 mx-2" min="1" max="5" step="1"
                            id="goodWithOtherDogs">
                        <span class="ms-2 range-label">Loves other dogs</span>
                    </div>
                </div>

                <br>

                <!-- Shedding level -->
                <div class="form-group">
                    <label for="sheddingLevel" class="form-label">
                        <strong>Shedding level</strong>
                    </label>
                    <div class="d-flex align-items-center">
                        <span class="me-2 range-label">Hardly sheds</span>
                        <input type="range" class="form-range flex-grow-1 mx-2" min="1" max="5" step="1"
                            id="sheddingLevel">
                        <span class="ms-2 range-label">Sheds a lot</span>
                    </div>
                </div>

                <br>

                <!-- Coat grooming frequency -->
                <div class="form-group">
                    <label for="coatGroomingFrequency" class="form-label">
                        <strong>Coat grooming frequency</strong>
                    </label>
                    <div class="d-flex align-items-center">
                        <span class="me-2 range-label">Infrequent grooming sufficient</span>
                        <input type="range" class="form-range flex-grow-1 mx-2" min="1" max="5" step="1"
                            id="coatGroomingFrequency">
                        <span class="ms-2 range-label">Frequent grooming required</span>
                    </div>
                </div>

                <br>

                <!-- Drooling level -->
                <div class="form-group">
                    <label for="droolingLevel" class="form-label">
                        <strong>Drooling level</strong>
                    </label>
                    <div class="d-flex align-items-center">
                        <span class="me-2 range-label">Doesn't drool much</span>
                        <input type="range" class="form-range flex-grow-1 mx-2" min="1" max="5" step="1"
                            id="droolingLevel">
                        <span class="ms-2 range-label">Slobbering</span>
                    </div>
                </div>

                <br>

                <!-- Coat length -->
                <div class="form-group">
                    <label for="coatLength" class="form-label">
                        <strong>Coat length</strong>
                    </label>
                    <div class="d-flex align-items-center">
                        <span class="me-2 range-label">Short haired</span>
                        <input type="range" class="form-range flex-grow-1 mx-2" min="1" max="5" step="1"
                            id="coatLength">
                        <span class="ms-2 range-label">Long haired</span>
                    </div>
                </div>

                <br>

                <!-- Openness to strangers -->
                <div class="form-group">
                    <label for="opennessToStrangers" class="form-label">
                        <strong>Openness to strangers</strong>
                    </label>
                    <div class="d-flex align-items-center">
                        <span class="me-2 range-label">Not open to strangers</span>
                        <input type="range" class="form-range flex-grow-1 mx-2" min="1" max="5" step="1"
                            id="opennessToStrangers">
                        <span class="ms-2 range-label">Open to strangers</span>
                    </div>
                </div>

                <br>

                <!-- Playfulness level -->
                <div class="form-group">
                    <label for="playfulnessLevel" class="form-label">
                        <strong>Playfulness level</strong>
                    </label>
                    <div class="d-flex align-items-center">
                        <span class="me-2 range-label">Not playful</span>
                        <input type="range" class="form-range flex-grow-1 mx-2" min="1" max="5" step="1"
                            id="playfulnessLevel">
                        <span class="ms-2 range-label">Very playful</span>
                    </div>
                </div>

                <br>

                <!-- Watchdog/protective nature -->
                <div class="form-group">
                    <label for="watchdogProtectiveNature" class="form-label">
                        <strong>Watchdog/Protective nature</strong>
                    </label>
                    <div class="d-flex align-items-center">
                        <span class="me-2 range-label">Not protective</span>
                        <input type="range" class="form-range flex-grow-1 mx-2" min="1" max="5" step="1"
                            id="watchdogProtectiveNature">
                        <span class="ms-2 range-label">Good guard dog</span>
                    </div>
                </div>

                <br>

                <!-- Adaptability level -->
                <div class="form-group">
                    <label for="adaptabilityLevel" class="form-label">
                        <strong>Adaptability level</strong>
                    </label>
                    <div class="d-flex align-items-center">
                        <span class="me-2 range-label">Not adaptable</span>
                        <input type="range" class="form-range flex-grow-1 mx-2" min="1" max="5" step="1"
                            id="adaptabilityLevel">
                        <span class="ms-2 range-label">Easily adaptable</span>
                    </div>
                </div>

                <br>

                <!-- Trainability level -->
                <div class="form-group">
                    <label for="trainabilityLevel" class="form-label">
                        <strong>Trainability level</strong>
                    </label>
                    <div class="d-flex align-items-center">
                        <span class="me-2 range-label">Not easily trainable</span>
                        <input type="range" class="form-range flex-grow-1 mx-2" min="1" max="5" step="1"
                            id="trainabilityLevel">
                        <span class="ms-2 range-label">Easily trained</span>
                    </div>
                </div>

                <br>

                <!-- Energy level -->
                <div class="form-group">
                    <label for="energyLevel" class="form-label">
                        <strong>Energy level</strong>
                    </label>
                    <div class="d-flex align-items-center">
                        <span class="me-2 range-label">Low energy</span>
                        <input type="range" class="form-range flex-grow-1 mx-2" min="1" max="5" step="1"
                            id="energyLevel">
                        <span class="ms-2 range-label">High energy</span>
                    </div>
                </div>

                <br>

                <!-- Barking level -->
                <div class="form-group">
                    <label for="barkingLevel" class="form-label">
                        <strong>Barking level</strong>
                    </label>
                    <div class="d-flex align-items-center">
                        <span class="me-2 range-label">Doesn't bark much</span>
                        <input type="range" class="form-range flex-grow-1 mx-2" min="1" max="5" step="1"
                            id="barkingLevel">
                        <span class="ms-2 range-label">Always barking</span>
                    </div>
                </div>

                <br>

                <!-- Mental stimulation level -->
                <div class="form-group">
                    <label for="mentalStimulationNeeds" class="form-label">
                        <strong>Mental stimulation needs</strong>
                    </label>
                    <div class="d-flex align-items-center">
                        <span class="me-2 range-label">Doesn't need much mental stimulation</span>
                        <input type="range" class="form-range flex-grow-1 mx-2" min="1" max="5" step="1"
                            id="mentalStimulationNeeds">
                        <span class="ms-2 range-label">Needs a lot of mental stimulation</span>
                    </div>
                </div>

                <br>

            </div>
        </div>
    </div>

    <br>

    <!-- Location -->
    <div class="form-group">
        <label>
            <strong>Where do you live?</strong>
        </label>
        <div>
            <div id="map" style="height:350px; width:480px;"></div>
            <text-area id="lat" hidden></text-area>
            <text-area id="lng" hidden></text-area>
        </div>
    </div>

    <br>

    <!-- Submit Button -->
    <button type="submit" class="btn btn-primary">Update profile</button>

    <br>
</form>
{{end}}

{{define "scripts"}}
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
    integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
    crossorigin=""></script>
<script>
    const profileForm = document.getElementById("profile-form");

    const options = {
        enableHighAccuracy: true, // Use high accuracy if available
        timeout: 100, // Timeout after 100 milliseconds
        maximumAge: 0 // Do not use a cached position
    };

    let latitude = -26.2056;
    let longitude = 28.0337;

    function renderMap() {
        let map = L.map('map').setView([latitude, longitude], 13);
        let my_divicon = L.divIcon({
            className: 'arrow_box'
        });
        let marker = L.marker([latitude, longitude], {
            draggable: true
        });

        L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            'attribution': 'Map data, copyright <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
        }
        ).addTo(map);

        function addToTextBox(lt, ln) {
            document.getElementById('lat').innerHTML = lt;
            document.getElementById('lng').innerHTML = ln;
        }

        // adds listener for drag end event
        marker.on('dragend', function (event) {
            let marker = event.target;
            let location = marker.getLatLng();
            let lat = location.lat;
            let lon = location.lng;
            addToTextBox(lat, lon);
        });

        marker.addTo(map);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Define the URL and data
        var url = "/api/profile";

        fetch(url, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Authorization": authToken
            },
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then((responseData) => {
                console.log("Success:", responseData);

                if (responseData.profile.latitude == 0 && responseData.profile.longitude == 0) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            latitude = position.coords.latitude;
                            longitude = position.coords.longitude;
                            console.log(`Latitude: ${latitude}, Longitude: ${longitude}`);
                            renderMap();
                        },
                        (error) => {
                            console.error("Error getting location:", error);
                            renderMap();
                        },
                        options
                    );
                } else {
                    latitude = responseData.profile.latitude;
                    longitude = responseData.profile.longitude;
                    renderMap();
                }

                document.getElementById("affectionateWithFamily").value = responseData.profile.affectionate_with_family;
                document.getElementById("goodWithYoungChildren").value = responseData.profile.good_with_young_children;
                document.getElementById("goodWithOtherDogs").value = responseData.profile.good_with_other_dogs;
                document.getElementById("sheddingLevel").value = responseData.profile.shedding_level;
                document.getElementById("coatGroomingFrequency").value = responseData.profile.coat_grooming_frequency;
                document.getElementById("droolingLevel").value = responseData.profile.drooling_level;
                document.getElementById("coatLength").value = responseData.profile.coat_length;
                document.getElementById("opennessToStrangers").value = responseData.profile.openness_to_strangers;
                document.getElementById("playfulnessLevel").value = responseData.profile.playfulness_level;
                document.getElementById("watchdogProtectiveNature").value = responseData.profile.watchdog_protective_nature;
                document.getElementById("adaptabilityLevel").value = responseData.profile.adaptability_level;
                document.getElementById("trainabilityLevel").value = responseData.profile.trainability_level;
                document.getElementById("energyLevel").value = responseData.profile.energy_level;
                document.getElementById("barkingLevel").value = responseData.profile.barking_level;
                document.getElementById("mentalStimulationNeeds").value = responseData.profile.mental_stimulation_needs;
            })
            .catch((error) => {
                console.error("Error:", error);
            });
    });

    profileForm.addEventListener("submit", (event) => {
        event.preventDefault();

        // Define the URL and data
        var url = "/api/profile";
        var data = {
            "affectionate_with_family": parseInt(document.getElementById("affectionateWithFamily").value),
            "good_with_young_children": parseInt(document.getElementById("goodWithYoungChildren").value),
            "good_with_other_dogs": parseInt(document.getElementById("goodWithOtherDogs").value),
            "shedding_level": parseInt(document.getElementById("sheddingLevel").value),
            "coat_grooming_frequency": parseInt(document.getElementById("coatGroomingFrequency").value),
            "drooling_level": parseInt(document.getElementById("droolingLevel").value),
            "coat_length": parseInt(document.getElementById("coatLength").value),
            "openness_to_strangers": parseInt(document.getElementById("opennessToStrangers").value),
            "playfulness_level": parseInt(document.getElementById("playfulnessLevel").value),
            "watchdog_protective_nature": parseInt(document.getElementById("watchdogProtectiveNature").value),
            "adaptability_level": parseInt(document.getElementById("adaptabilityLevel").value),
            "trainability_level": parseInt(document.getElementById("trainabilityLevel").value),
            "energy_level": parseInt(document.getElementById("energyLevel").value),
            "barking_level": parseInt(document.getElementById("barkingLevel").value),
            "mental_stimulation_needs": parseInt(document.getElementById("mentalStimulationNeeds").value),
            "latitude": parseFloat(document.getElementById("lat").textContent),
            "longitude": parseFloat(document.getElementById("lng").textContent)
        };

        console.log(data)

        // Send the POST request
        fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": authToken
            },
            body: JSON.stringify(data),
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then((responseData) => {
                console.log("Success:", responseData);
            })
            .catch((error) => {
                console.error("Error:", error);
            });
    });
</script>
{{end}}